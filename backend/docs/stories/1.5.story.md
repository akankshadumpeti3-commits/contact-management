# Story 1.5: Update Tests for MongoDB

## Status
Draft

## Story
**As a** developer,
**I want** update all contact-related tests to use MongoDB test database,
**so that** the test suite validates MongoDB implementation

## Acceptance Criteria
1. All existing unit tests pass with Mongoose implementation
2. All existing integration tests pass with MongoDB
3. Test database setup uses in-memory MongoDB or test container
4. Tests are isolated (no cross-test data contamination)
5. Test performance is acceptable (< 30s for full suite)

## Tasks / Subtasks

- [ ] **Task 1: Install Testing Dependencies** (AC: 3)
  - [ ] Install `mongodb-memory-server` package for in-memory MongoDB testing
  - [ ] Verify Jest configuration in package.json is compatible
  - [ ] Update test scripts if needed

- [ ] **Task 2: Update Contact Service Unit Tests** (AC: 1, 4)
  - [ ] Update `src/contact/contact.service.spec.ts` to mock Mongoose Model instead of TypeORM Repository
  - [ ] Implement test setup to create mock Mongoose models
  - [ ] Add tests for create() operation with mocked Mongoose Model
  - [ ] Add tests for readAll() operation (model.find().exec())
  - [ ] Add tests for update() operation (model.findByIdAndUpdate())
  - [ ] Add tests for delete() operation (model.findByIdAndDelete())
  - [ ] Add error handling test cases (e.g., contact not found)
  - [ ] Ensure test teardown properly cleans up mocks

- [ ] **Task 3: Update Contact Controller Unit Tests** (AC: 1, 4)
  - [ ] Update `src/contacts/contacts.controller.spec.ts` to inject mocked ContactService
  - [ ] Add tests for read() endpoint
  - [ ] Add tests for create() endpoint
  - [ ] Add tests for update() endpoint
  - [ ] Add tests for delete() endpoint
  - [ ] Verify controller delegates to service correctly

- [ ] **Task 4: Update E2E/Integration Tests** (AC: 2, 3, 4)
  - [ ] Update `test/app.e2e-spec.ts` to use mongodb-memory-server
  - [ ] Create test setup helper to initialize in-memory MongoDB instance
  - [ ] Configure MongooseModule to connect to test database
  - [ ] Add beforeAll hook to start mongodb-memory-server
  - [ ] Add beforeEach hook to seed test data
  - [ ] Add afterEach hook to clear test database (ensure isolation)
  - [ ] Add afterAll hook to stop mongodb-memory-server
  - [ ] Add integration tests for GET /contacts endpoint
  - [ ] Add integration tests for POST /contacts endpoint
  - [ ] Add integration tests for PUT /contacts/:id endpoint
  - [ ] Add integration tests for DELETE /contacts/:id endpoint
  - [ ] Verify response formats and status codes

- [ ] **Task 5: Verify Test Performance and Coverage** (AC: 5)
  - [ ] Run full test suite and verify completion time < 30s
  - [ ] Run test coverage report (`npm run test:cov`)
  - [ ] Verify all tests pass
  - [ ] Document any performance optimizations made
  - [ ] Ensure no cross-test data contamination occurs

## Dev Notes

### Previous Story Insights
No previous story (1.4) found in this working directory.

### Data Models
**Contact Schema** [Source: architecture/data-models-and-apis.md#contact-model]
- Location: `src/contacts/schemas/contact.schema.ts`
- Fields to test:
  - `_id`: ObjectId (MongoDB auto-generated)
  - `name`: String (required, max 100)
  - `title`: String (max 100)
  - `email`: String (required, unique, lowercase)
  - `phone`: String (max 20)
  - `address`: String (max 200)
  - `city`: String (max 100, indexed)
  - `createdAt`: Date (auto-managed)
  - `updatedAt`: Date (auto-managed)

**Validation Rules to Test**:
- Email must be unique
- Email is required
- Name is required
- Timestamps are automatically managed

### Testing Requirements

**Framework and Location** [Source: architecture/technical-summary.md#current-tech-stack]
- Framework: Jest v26.4.2
- Unit test location: `src/**/*.spec.ts`
- E2E test location: `test/*.e2e-spec.ts`

**Test Strategy** [Source: architecture/testing-reality.md#target-test-strategy]

**Unit Tests (Service Layer)**:
- Test business logic in isolation
- Mock Mongoose repositories using Jest mocks
- Cover edge cases (validation, errors)
- Target: 80% code coverage
- Mock Model<Contact> with jest.fn() for:
  - `model.create()` - for create operations
  - `model.find().exec()` - for readAll operations
  - `model.findById()` - for single contact retrieval
  - `model.findByIdAndUpdate()` - for update operations
  - `model.findByIdAndDelete()` - for delete operations

**Integration Tests (API Layer)**:
- Test full request/response cycle
- Use mongodb-memory-server for in-memory database
- Validate DTOs, error handling, status codes
- Target: 100% endpoint coverage

**E2E Tests (Full System)**:
- Test critical user workflows
- Use test database (in-memory MongoDB)
- Test full CRUD cycle

**Test Commands** [Source: architecture/testing-reality.md#current-test-coverage]:
```bash
npm test              # Unit tests
npm run test:watch    # Watch mode
npm run test:cov      # Coverage report
npm run test:e2e      # End-to-end tests
```

### File Locations

**Existing Test Files to Update**:
- `src/contact/contact.service.spec.ts` - Service unit tests (update for Mongoose)
- `src/contacts/contacts.controller.spec.ts` - Controller unit tests (update for Mongoose)
- `test/app.e2e-spec.ts` - E2E tests (update for MongoDB)

**Test Configuration Files**:
- `test/jest-e2e.json` - E2E test configuration [Source: architecture/testing-reality.md#integration-tests]
- `package.json` - Test scripts configuration

### Service Implementation to Test

**Contact Service** [Source: architecture/source-tree-and-module-organization.md#current-contact-service]
Current service uses TypeORM Repository methods that need Mongoose equivalents in tests:
- `repository.save()` → `model.create()` or `document.save()`
- `repository.find()` → `model.find().exec()`
- `repository.update()` → `model.findByIdAndUpdate()`
- `repository.delete()` → `model.findByIdAndDelete()`

### API Endpoints to Test

**Current Endpoints** [Source: architecture/data-models-and-apis.md#current-api-endpoints]:
- `GET /contacts` - List all contacts
- `POST /contacts/create` - Create contact (non-RESTful path)
- `PUT /contacts/:id/update` - Update contact (non-RESTful path)
- `DELETE /contacts/:id/delete` - Delete contact (non-RESTful path)

### Testing Standards

**Test Data Strategy** [Source: architecture/testing-reality.md#test-data]:
- Create fixtures for sample contacts
- Use factory pattern for generating test data
- Ensure test data is isolated per test
- Clean up test data after each test to prevent contamination

**MongoDB Memory Server Setup**:
- Package: `mongodb-memory-server`
- Use MongoMemoryServer class to create in-memory MongoDB instance
- Start server in beforeAll hook
- Stop server in afterAll hook
- Clear database in afterEach to ensure test isolation

**Performance Requirements** [Source: Epic 1.5 AC#5]:
- Full test suite must complete in < 30 seconds
- Use in-memory MongoDB for speed
- Minimize test setup/teardown overhead

### Technical Constraints

**Dependencies to Install** [Source: Epic 1.5 Technical Notes]:
- `mongodb-memory-server` - For in-memory MongoDB testing

**Mongoose Mocking Strategy**:
- Mock Mongoose Model in unit tests using Jest
- Do NOT use real database connections in unit tests
- Use in-memory MongoDB ONLY for integration/e2e tests

**Test Isolation Requirements**:
- Each test must be independent
- Clear database between integration tests
- No shared state between tests
- Use fresh mock instances for each unit test

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_Not yet implemented_

### Debug Log References
_Not yet implemented_

### Completion Notes List
_Not yet implemented_

### File List
_Not yet implemented_

## QA Results
_Not yet performed_
