# Story 1.3: Replace TypeORM with Mongoose in Contact Module

**Epic**: 1 - Database Migration Foundation
**Story**: 1.3

---

## Status

**Draft**

---

## Story

**As a** developer
**I want to** refactor the Contact module to use Mongoose instead of TypeORM
**So that** all contact operations use MongoDB

---

## Acceptance Criteria

1. Contact service uses Mongoose Model instead of TypeORM Repository
2. All CRUD operations (create, findAll, findOne, update, delete) work correctly
3. Existing API endpoints function without changes
4. DTOs and validation remain unchanged
5. Error handling is maintained
6. No TypeORM dependencies remain in Contact module

---

## Tasks / Subtasks

- [ ] **Task 1: Create ContactsModule (if not exists)** (AC: 1, 6)
  - [ ] Create `src/contacts/contacts.module.ts` if it doesn't exist
  - [ ] Import `MongooseModule.forFeature([{ name: Contact.name, schema: ContactSchema }])`
  - [ ] Register ContactService and ContactsController in module
  - [ ] Export ContactService for potential use by other modules

- [ ] **Task 2: Refactor ContactService to use Mongoose Model** (AC: 1, 2, 5)
  - [ ] Update constructor to inject `@InjectModel(Contact.name) private contactModel: Model<ContactDocument>`
  - [ ] Remove TypeORM Repository injection (`@InjectRepository(Contact)`)
  - [ ] Replace `repository.save()` with `this.contactModel.create()` in create method
  - [ ] Replace `repository.find()` with `this.contactModel.find().exec()` in readAll method
  - [ ] Implement findOne method using `this.contactModel.findById(id).exec()`
  - [ ] Replace `repository.update()` with `this.contactModel.findByIdAndUpdate(id, updateData, { new: true }).exec()` in update method
  - [ ] Replace `repository.delete()` with `this.contactModel.findByIdAndDelete(id).exec()` in delete method
  - [ ] Add error handling for "not found" cases (throw NotFoundException)
  - [ ] Ensure all methods return proper types (Contact/Contact[] instead of UpdateResult/DeleteResult)

- [ ] **Task 3: Update ContactsController (if needed)** (AC: 3)
  - [ ] Verify all existing endpoints still work without changes
  - [ ] Ensure controller imports are updated if Contact type changes
  - [ ] Verify response types match expectations (Contact entities, not database results)

- [ ] **Task 4: Remove TypeORM dependencies from Contact module** (AC: 6)
  - [ ] Remove `TypeOrmModule.forFeature([Contact])` from contacts.module.ts (or app.module.ts)
  - [ ] Delete `src/entities/contact.entity.ts` (TypeORM entity file)
  - [ ] Remove any TypeORM imports from ContactService
  - [ ] Verify no TypeORM dependencies remain in Contact-related files

- [ ] **Task 5: Clean up root module** (AC: 6)
  - [ ] Remove TypeORM configuration from `app.module.ts` (commented out from Story 1.1)
  - [ ] Import ContactsModule in app.module.ts imports array
  - [ ] Remove ContactService and ContactsController from app.module providers/controllers (should be in ContactsModule)
  - [ ] Uninstall TypeORM and MySQL packages: `npm uninstall typeorm @nestjs/typeorm mysql`

- [ ] **Task 6: Test all CRUD operations** (AC: 2, 3)
  - [ ] Manually test GET /contacts (list all)
  - [ ] Manually test POST /contacts/create (create contact)
  - [ ] Manually test PUT /contacts/:id/update (update contact)
  - [ ] Manually test DELETE /contacts/:id/delete (delete contact)
  - [ ] Verify MongoDB contains correct data after operations
  - [ ] Test error cases (invalid ID, duplicate email, etc.)

- [ ] **Task 7: Update unit tests** (AC: 2, 5)
  - [ ] Update ContactService tests to mock Mongoose Model instead of TypeORM Repository
  - [ ] Test create, readAll, findOne, update, delete methods
  - [ ] Test error handling (NotFoundException for missing contacts)
  - [ ] Ensure all tests pass

---

## Dev Notes

### Prerequisites

**CRITICAL DEPENDENCY**: This story requires Story 1.2 to be completed first. Story 1.2 must create:
- `src/contacts/schemas/contact.schema.ts` - Mongoose schema for Contact
- Contact schema should be registered and exported for use in this story

If Story 1.2 is not complete, you must create the Contact schema before proceeding with this story.

### Previous Story Insights

**From Story 1.1 Completion** [Source: docs/stories/1.1.story.md#dev-agent-record]:
- NestJS upgraded from v7 to v11
- MongoDB v8.2.1 installed and configured
- Mongoose v8 configured with `@nestjs/mongoose` v11
- TypeORM/MySQL temporarily commented out in app.module.ts (not removed yet)
- ConfigModule and MongooseModule are already configured globally
- Application successfully connects to MongoDB on startup

**Technical Debt from Story 1.1**:
- Jest configuration issues (Jest v26 incompatible with ts-jest v29) - may affect testing in this story
- TypeORM dependencies still installed but commented out - will be fully removed in this story

### Current Module Structure

**Current State** [Source: docs/architecture/source-tree-and-module-organization.md#contacts-module-current-state]:
- Controller: `src/contacts/contacts.controller.ts` (plural folder)
- Service: `src/contact/contact.service.ts` (singular folder - inconsistent naming ⚠️)
- Entity: `src/entities/contact.entity.ts` (TypeORM entity)
- Module registration: ContactService and ContactsController registered in root `app.module.ts` (flat structure)

**Structural Issues to Resolve**:
- Controller and service in different folders (contacts/ vs contact/)
- No dedicated ContactsModule (services/controllers registered in app.module)
- TypeORM entity in separate entities/ folder

**Target Structure** [Source: docs/architecture/technical-summary.md#target-structure]:
```
src/contacts/
├── contacts.module.ts       # Feature module
├── contacts.controller.ts   # Controller
├── contacts.service.ts      # Service (Mongoose-based)
├── schemas/
│   └── contact.schema.ts    # Mongoose schema (from Story 1.2)
├── dto/
│   ├── create-contact.dto.ts  # (future stories)
│   └── update-contact.dto.ts  # (future stories)
```

### TypeORM to Mongoose Migration Mapping

**Current Contact Service Implementation** [Source: docs/architecture/source-tree-and-module-organization.md#current-contact-service]:
```typescript
@Injectable()
export class ContactService {
    constructor(
        @InjectRepository(Contact)
        private contactRepository: Repository<Contact>
    ) {}

    async create(contact: Contact): Promise<Contact> {
        return await this.contactRepository.save(contact);
    }

    async readAll(): Promise<Contact[]> {
        return await this.contactRepository.find();
    }

    async update(contact: Contact): Promise<UpdateResult> {
        return await this.contactRepository.update(contact.id, contact);
    }

    async delete(id): Promise<DeleteResult> {
        return await this.contactRepository.delete(id);
    }
}
```

**Target Mongoose Implementation** [Source: docs/prd/epic-1-database-migration.md#story-1.3-technical-notes]:
```typescript
@Injectable()
export class ContactService {
    constructor(
        @InjectModel(Contact.name)
        private contactModel: Model<ContactDocument>
    ) {}

    async create(contact: Contact): Promise<Contact> {
        const created = await this.contactModel.create(contact);
        return created;
    }

    async readAll(): Promise<Contact[]> {
        return await this.contactModel.find().exec();
    }

    async findOne(id: string): Promise<Contact> {
        const contact = await this.contactModel.findById(id).exec();
        if (!contact) {
            throw new NotFoundException(`Contact with ID ${id} not found`);
        }
        return contact;
    }

    async update(id: string, contact: Partial<Contact>): Promise<Contact> {
        const updated = await this.contactModel.findByIdAndUpdate(
            id,
            contact,
            { new: true }
        ).exec();
        if (!updated) {
            throw new NotFoundException(`Contact with ID ${id} not found`);
        }
        return updated;
    }

    async delete(id: string): Promise<Contact> {
        const deleted = await this.contactModel.findByIdAndDelete(id).exec();
        if (!deleted) {
            throw new NotFoundException(`Contact with ID ${id} not found`);
        }
        return deleted;
    }
}
```

**Key Differences**:
- Inject `Model<ContactDocument>` instead of `Repository<Contact>`
- Use Mongoose methods: `.create()`, `.find().exec()`, `.findById()`, `.findByIdAndUpdate()`, `.findByIdAndDelete()`
- Return actual Contact entities instead of `UpdateResult`/`DeleteResult`
- Add error handling with `NotFoundException` for missing contacts
- MongoDB uses string IDs (ObjectId) instead of numeric IDs

### Contact Schema Reference

**Expected Contact Schema** [Source: docs/architecture/source-tree-and-module-organization.md#target-implementation]:
```typescript
@Schema({ timestamps: true })
export class Contact {
  @Prop({ required: true, maxlength: 100 })
  name: string;

  @Prop({ maxlength: 100 })
  title: string;

  @Prop({ required: true, unique: true, lowercase: true })
  email: string;

  @Prop({ maxlength: 20 })
  phone: string;

  @Prop({ maxlength: 200 })
  address: string;

  @Prop({ maxlength: 100, index: true })
  city: string;

  // Future fields (not for this story):
  // categoryId, tagIds
}

export type ContactDocument = Contact & Document;
export const ContactSchema = SchemaFactory.createForClass(Contact);
```

**Note**: Story 1.2 should create this schema. If it doesn't exist, create it as part of this story.

### API Endpoints - No Changes Required

**Current API Endpoints** [Source: docs/architecture/data-models-and-apis.md#current-api-endpoints]:
- GET `/contacts` - List all contacts
- POST `/contacts/create` - Create contact
- PUT `/contacts/:id/update` - Update contact
- DELETE `/contacts/:id/delete` - Delete contact

**Important**: AC #3 requires these endpoints to continue working without changes. The refactoring is internal to the service layer only.

**Known API Issues** (not to be fixed in this story):
- Non-RESTful paths (verbs in URLs like `/create`, `/update`, `/delete`) - will be fixed in future stories
- No input validation - will be added in future stories
- Raw entity responses instead of standardized format - will be enhanced in future stories

### Module Organization

**Current App Module** [Source: docs/architecture/source-tree-and-module-organization.md#app-module]:
```typescript
@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    MongooseModule.forRootAsync({...}),  // Added in Story 1.1
    // TypeOrmModule.forRoot({...}),     // Commented out in Story 1.1
    // TypeOrmModule.forFeature([Contact]), // To be removed
  ],
  controllers: [AppController, ContactsController],  // ContactsController should move to ContactsModule
  providers: [AppService, ContactService],           // ContactService should move to ContactsModule
})
```

**Target App Module** [Source: docs/architecture/source-tree-and-module-organization.md#required-changes]:
```typescript
@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    MongooseModule.forRootAsync({...}),
    ContactsModule,  // Import feature module
  ],
  controllers: [AppController],  // Only root controller
  providers: [AppService],       // Only root service
})
```

**Target ContactsModule** (to be created):
```typescript
@Module({
  imports: [
    MongooseModule.forFeature([
      { name: Contact.name, schema: ContactSchema }
    ])
  ],
  controllers: [ContactsController],
  providers: [ContactService],
  exports: [ContactService],  // Export for potential use by other modules
})
export class ContactsModule {}
```

### File Locations and Naming

**Files to Modify**:
- `src/contact/contact.service.ts` - Refactor to use Mongoose (may move to `src/contacts/` for consistency)
- `src/contacts/contacts.controller.ts` - Update imports if needed
- `src/app.module.ts` - Remove TypeORM config, import ContactsModule

**Files to Create**:
- `src/contacts/contacts.module.ts` - New feature module

**Files to Delete**:
- `src/entities/contact.entity.ts` - TypeORM entity (no longer needed)

**Files to Reference** (should exist from Story 1.2):
- `src/contacts/schemas/contact.schema.ts` - Mongoose schema

**Optional Cleanup**:
- Consider moving `src/contact/contact.service.ts` to `src/contacts/contacts.service.ts` for consistency
- Remove empty `src/contact/` and `src/entities/` directories after cleanup

### Dependencies to Remove

**Packages to Uninstall** [Source: docs/architecture/technical-summary.md#target-tech-stack]:
```bash
npm uninstall typeorm @nestjs/typeorm mysql
```

**Verify No TypeORM Imports Remain**:
```bash
# Search for any remaining TypeORM imports
grep -r "from 'typeorm'" src/
grep -r "from '@nestjs/typeorm'" src/
```

### Error Handling

**Current Implementation**: No error handling for missing contacts

**Target Implementation**:
- Import `NotFoundException` from `@nestjs/common`
- Throw `NotFoundException` when contact not found in findOne, update, delete
- Example: `throw new NotFoundException(\`Contact with ID \${id} not found\`);`

### ID Type Changes

**IMPORTANT**: MongoDB uses ObjectId (string representation) instead of auto-increment integers

**Current**: `id: number` (auto-increment)
**Target**: `_id: ObjectId` (MongoDB default, accessed as string in TypeScript)

**Impact on Controller**:
- `@Param('id')` will receive string instead of number
- Remove `contact.id = Number(id)` conversions
- Pass ID as string to service methods

---

## Testing

**Test Framework**: Jest v26.4.2 [Source: docs/architecture/technical-summary.md#current-tech-stack]

**Known Issue** [Source: docs/stories/1.1.story.md#technical-debt]:
- Jest v26 incompatible with ts-jest v29 (from Story 1.1 upgrade)
- Unit tests may fail until Jest is upgraded or ts-jest is downgraded
- Manual testing will be primary verification method for this story

**Testing Requirements** [Source: docs/architecture/testing-reality.md]:

**Unit Tests**:
- Test file location: `src/contacts/contacts.service.spec.ts` (co-located with service)
- Mock Mongoose Model using Jest mocks
- Test methods: create, readAll, findOne, update, delete
- Test error cases: NotFoundException for missing contacts
- Target: 80% code coverage

**Mock Pattern for Mongoose Model**:
```typescript
const mockContactModel = {
  create: jest.fn(),
  find: jest.fn().mockReturnValue({ exec: jest.fn() }),
  findById: jest.fn().mockReturnValue({ exec: jest.fn() }),
  findByIdAndUpdate: jest.fn().mockReturnValue({ exec: jest.fn() }),
  findByIdAndDelete: jest.fn().mockReturnValue({ exec: jest.fn() }),
};
```

**Integration Tests**:
- Test file location: `test/contacts.e2e-spec.ts`
- Use in-memory MongoDB (mongodb-memory-server) - may be added in future story
- For this story: Manual API testing is sufficient

**Manual Testing Checklist**:
1. Start application (`npm run start:dev`)
2. Test GET /contacts - should return empty array or existing contacts
3. Test POST /contacts/create with valid contact data
4. Test GET /contacts - verify new contact appears
5. Test PUT /contacts/:id/update with valid ID
6. Test DELETE /contacts/:id/delete with valid ID
7. Test error cases: invalid ID, missing ID, duplicate email

**Test Commands** [Source: docs/architecture/testing-reality.md]:
```bash
npm test              # Run unit tests (may fail due to Jest issue)
npm run test:watch    # Watch mode
npm run test:cov      # Coverage report
npm run test:e2e      # End-to-end tests
```

**Testing Strategy for This Story**:
- Update unit tests to mock Mongoose Model
- If Jest issues prevent tests from running, document as technical debt
- Primary verification: Manual API testing
- Verify all CRUD operations work correctly
- Verify error handling for missing contacts

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

---

## QA Results

_To be populated by QA Agent_
