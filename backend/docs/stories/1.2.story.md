# Story 1.2: Create Contact Mongoose Schema

**Epic**: 1 - Database Migration Foundation
**Story**: 1.2

---

## Status

**Draft**

---

## Story

**As a** developer
**I want to** create a Mongoose schema for Contact matching current TypeORM entity fields
**So that** contact data can be stored in MongoDB with proper validation

---

## Acceptance Criteria

1. Contact schema created with all existing fields: name, title, email, phone, address, city
2. Field validations match current requirements (required fields, unique email, etc.)
3. Timestamps (createdAt, updatedAt) are automatically managed
4. Schema file follows NestJS/Mongoose conventions
5. DTOs remain unchanged (API contract preserved)

---

## Tasks / Subtasks

- [ ] **Task 1: Create schema directory structure** (AC: 4)
  - [ ] Create `src/contacts/schemas/` directory
  - [ ] Verify directory structure follows NestJS conventions

- [ ] **Task 2: Create Contact Mongoose schema file** (AC: 1, 2, 3, 4)
  - [ ] Create `src/contacts/schemas/contact.schema.ts`
  - [ ] Import necessary Mongoose decorators (@Schema, @Prop, SchemaFactory)
  - [ ] Define Contact class with @Schema decorator and `timestamps: true` option
  - [ ] Add all existing fields from TypeORM entity: name, title, email, phone, address, city
  - [ ] Apply field validations:
    - `name`: required, maxlength: 100
    - `title`: maxlength: 100
    - `email`: required, unique, lowercase
    - `phone`: maxlength: 20
    - `address`: maxlength: 200
    - `city`: maxlength: 100, indexed
  - [ ] Add future fields for Epic completeness (optional/nullable for now):
    - `categoryId`: ObjectId reference to Category (optional)
    - `tagIds`: Array of ObjectId references to Tag (optional)
  - [ ] Export ContactDocument type (Contact & Document)
  - [ ] Export ContactSchema using SchemaFactory.createForClass()

- [ ] **Task 3: Create text search index** (AC: 2)
  - [ ] Add text index on schema for fields: name, title, email, phone, address, city
  - [ ] Use ContactSchema.index() method after schema creation

- [ ] **Task 4: Verify DTOs remain unchanged** (AC: 5)
  - [ ] Review existing Contact entity usage in controllers
  - [ ] Confirm no DTO changes needed (API contract preserved)
  - [ ] Document that DTOs will be created in future stories

- [ ] **Task 5: Add schema to module (preparation)** (AC: 4)
  - [ ] Note: This task prepares for Story 1.3 integration
  - [ ] Document that schema will be registered in ContactsModule in Story 1.3
  - [ ] No module changes in this story (schema creation only)

- [ ] **Task 6: Create unit tests for schema** (AC: 1, 2, 3)
  - [ ] Create `src/contacts/schemas/contact.schema.spec.ts`
  - [ ] Test: Schema compiles without errors
  - [ ] Test: Required field validation (name, email)
  - [ ] Test: Email uniqueness constraint
  - [ ] Test: Field length validations
  - [ ] Test: Timestamps are auto-managed (createdAt, updatedAt)
  - [ ] Use mongodb-memory-server or mock Mongoose connection

---

## Dev Notes

### Previous Story Insights

**From Story 1.1 Completion** [Source: docs/stories/1.1.story.md#dev-agent-record]:
- ✅ NestJS upgraded from v7 to **v11** (current version)
- ✅ Mongoose **v8** installed and configured (not v6 as originally planned)
- ✅ MongoDB **v8.2.1** running and connected
- ✅ TypeORM/MySQL code commented out in app.module.ts (will be removed in Story 1.3)
- ⚠️ **Deprecated Mongoose options removed**: `useNewUrlParser` and `useUnifiedTopology` (MongoDB driver v4+ no longer needs these)
- ⚠️ **Technical Debt**: Jest unit tests currently failing (Jest v26 incompatible with ts-jest v29 - needs upgrade)

**Important Context for This Story**:
- Use **Mongoose v8** syntax (not v6 as in original architecture docs)
- Use **NestJS v11** conventions (SchemaFactory pattern)
- TypeORM Contact entity still exists at `src/entities/contact.entity.ts` but is NOT used
- Contact service and controller are currently commented out in AppModule

### Current Contact Entity Structure

**TypeORM Entity** [Source: src/entities/contact.entity.ts]:
```typescript
@Entity()
export class Contact {
    @PrimaryGeneratedColumn()
    id: number;               // Will become MongoDB _id (ObjectId)

    @Column()
    name: string;

    @Column()
    title: string;

    @Column()
    email: string;

    @Column()
    phone: string;

    @Column()
    address: string;

    @Column()
    city: string;
}
```

**Issues with Current Entity** [Source: docs/architecture/data-models-and-apis.md#current-data-model]:
- ❌ No timestamps (createdAt, updatedAt)
- ❌ No email uniqueness constraint
- ❌ No field validation (length, format)
- ❌ No relationships (categories, tags)

### Target Mongoose Schema Specification

**Schema Location**: `src/contacts/schemas/contact.schema.ts` [Source: docs/architecture/technical-summary.md#target-structure]

**Complete Schema Definition** [Source: docs/architecture/source-tree-and-module-organization.md#target-implementation]:
```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose';
import * as mongoose from 'mongoose';

@Schema({ timestamps: true })  // Auto-manages createdAt, updatedAt
export class Contact {
  @Prop({ required: true, maxlength: 100 })
  name: string;

  @Prop({ maxlength: 100 })
  title: string;

  @Prop({ required: true, unique: true, lowercase: true })
  email: string;

  @Prop({ maxlength: 20 })
  phone: string;

  @Prop({ maxlength: 200 })
  address: string;

  @Prop({ maxlength: 100, index: true })
  city: string;

  @Prop({ type: mongoose.Schema.Types.ObjectId, ref: 'Category' })
  categoryId: mongoose.Types.ObjectId;  // Optional for now

  @Prop({ type: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Tag' }] })
  tagIds: mongoose.Types.ObjectId[];  // Optional for now

  // Timestamps automatically added: createdAt, updatedAt
}

export type ContactDocument = Contact & Document;
export const ContactSchema = SchemaFactory.createForClass(Contact);

// Create text index for search
ContactSchema.index({
  name: 'text',
  title: 'text',
  email: 'text',
  phone: 'text',
  address: 'text',
  city: 'text',
});
```

### Field Validation Rules

**Field Specifications** [Source: docs/architecture/data-models-and-apis.md#contact-model]:

| Field | Type | Required | Validation | Index | Notes |
|-------|------|----------|------------|-------|-------|
| `_id` | ObjectId | Auto | MongoDB auto-generated | Primary | Replaces TypeORM `id` |
| `name` | String | Yes | max: 100 chars | Text | Required field |
| `title` | String | No | max: 100 chars | Text | Optional |
| `email` | String | Yes | Lowercase, unique | Unique, Text | Must be unique |
| `phone` | String | No | max: 20 chars | Text | Optional |
| `address` | String | No | max: 200 chars | Text | Optional |
| `city` | String | No | max: 100 chars | Regular, Text | Indexed for filtering |
| `categoryId` | ObjectId | No | ref: 'Category' | Regular | Added for Epic scope |
| `tagIds` | ObjectId[] | No | ref: 'Tag' | Array | Added for Epic scope |
| `createdAt` | Date | Auto | Timestamp | - | Auto-managed |
| `updatedAt` | Date | Auto | Timestamp | - | Auto-managed |

**Indexes to Create** [Source: docs/architecture/data-models-and-apis.md#contact-model]:
1. `email` - Unique index (prevents duplicate emails)
2. `categoryId` - Regular index (query optimization for filtering by category)
3. `tagIds` - Array index (query optimization for tag filtering)
4. `city` - Regular index (query optimization for city filtering)
5. Text index - Composite text index on name, title, email, phone, address, city (full-text search)

### Project Structure Alignment

**Current Structure** [Source: docs/architecture/technical-summary.md#current-structure]:
```
src/
├── entities/
│   └── contact.entity.ts          # OLD: TypeORM entity (will be removed in Story 1.3)
├── contact/
│   └── contact.service.ts         # ⚠️ Inconsistent: singular folder
└── contacts/
    └── contacts.controller.ts     # ⚠️ Inconsistent: plural folder
```

**Target Structure** [Source: docs/architecture/technical-summary.md#target-structure]:
```
src/
└── contacts/                      # ✅ Consolidated module
    ├── schemas/
    │   └── contact.schema.ts      # NEW: This story creates this file
    ├── dto/                       # FUTURE: Story 2.x will create DTOs
    │   ├── create-contact.dto.ts
    │   ├── update-contact.dto.ts
    │   ├── filter-contact.dto.ts
    │   └── search-contact.dto.ts
    ├── interfaces/                # FUTURE: Optional
    │   └── contact.interface.ts
    ├── contacts.module.ts         # EXISTS: Currently commented out
    ├── contacts.controller.ts     # EXISTS: Currently commented out
    └── contacts.service.ts        # FUTURE: Will be refactored in Story 1.3
```

**File to Create in This Story**:
- `src/contacts/schemas/contact.schema.ts` - NEW file

**Files NOT Modified in This Story**:
- `src/contacts/contacts.controller.ts` - No changes (still commented out)
- `src/contact/contact.service.ts` - No changes (will be refactored in Story 1.3)
- `src/app.module.ts` - No changes (schema registration happens in Story 1.3)

### NestJS/Mongoose Conventions

**Mongoose Integration Pattern** [Source: docs/architecture/enhancement-implementation-guide.md#phase-1]:

1. **Schema Definition**: Use `@Schema()` decorator with options
2. **Field Definition**: Use `@Prop()` decorator for each field
3. **Schema Factory**: Export schema using `SchemaFactory.createForClass()`
4. **Document Type**: Export type alias combining schema class and Document
5. **Indexes**: Add indexes after schema creation using `.index()` method

**NestJS v11 Mongoose Conventions**:
- Use `@nestjs/mongoose` decorators
- Enable timestamps with `@Schema({ timestamps: true })`
- Use `SchemaFactory.createForClass()` (not manual new mongoose.Schema())
- Export both class definition and schema constant
- Co-locate schemas with their feature module

### Future Epic Scope Context

**Why categoryId and tagIds are included** [Source: docs/prd/epic-1-database-migration.md]:
- Epic 1 is the Database Migration Foundation
- Story 1.3 will replace TypeORM with Mongoose
- Story 1.4 will migrate existing data
- Later epics will add Category and Tag features
- Including these fields NOW (as optional) prevents schema migration later
- Existing contacts will have `null`/`undefined` for these fields until features are added

**Field Status**:
- `categoryId`: Optional, ref to Category schema (not created yet)
- `tagIds`: Optional, array ref to Tag schema (not created yet)
- These fields will NOT be used until Epic 2 (Categories & Tags Implementation)

### DTO Preservation Requirement

**AC #5: DTOs remain unchanged** [Source: docs/prd/epic-1-database-migration.md#story-1.2]:
- Current implementation uses raw Contact entity in controller (`@Body() contact: Contact`)
- No formal DTOs exist yet (technical debt)
- This story creates the SCHEMA ONLY
- DTOs will be created in later stories (likely Epic 2 or 5)
- API contract must remain unchanged (same request/response format)

**Current Controller Pattern** [Source: docs/architecture/source-tree-and-module-organization.md#current-contact-controller]:
```typescript
@Post('create')
async create(@Body() contact: Contact): Promise<any> {  // Uses entity directly
    return this.contactService.create(contact);
}
```

**This will continue to work** because:
- Mongoose documents are JavaScript objects
- Schema validation happens at database layer
- Controller doesn't need to change for this story

---

## Testing

**Test Framework**: Jest v26.4.2 [Source: docs/architecture/technical-summary.md#current-tech-stack]

**Testing Requirements** [Source: docs/architecture/testing-reality.md]:

### Unit Tests for Schema

**Test File Location**: `src/contacts/schemas/contact.schema.spec.ts` (co-located with schema)

**Test Strategy**:
- Test schema definition compiles without errors
- Test field validations (required, maxlength, unique)
- Test timestamp auto-generation
- Mock or use in-memory MongoDB for isolated testing

**Required Test Cases**:
1. ✅ Schema creation - Verify schema compiles
2. ✅ Required fields - Test name and email are required
3. ✅ Email uniqueness - Test duplicate email rejection
4. ✅ Field length validation - Test maxlength constraints
5. ✅ Timestamps - Verify createdAt and updatedAt are auto-managed
6. ✅ Optional fields - Test categoryId and tagIds can be null/undefined
7. ✅ Index creation - Verify text index exists

**Testing Tools** [Source: docs/architecture/testing-reality.md]:
- Jest (already installed)
- `mongodb-memory-server` (recommended for future stories, optional for schema tests)
- Can use schema validation without database connection

**Test Commands** [Source: CLAUDE.md#testing]:
```bash
npm test                          # Run unit tests
npm run test:watch               # Watch mode
npm run test:cov                 # Coverage report
```

**Known Testing Issue** [Source: docs/stories/1.1.story.md#technical-debt]:
- ⚠️ Jest v26 + ts-jest v29 compatibility issue exists
- Unit tests may fail to run
- This is documented technical debt from Story 1.1
- Story 1.2 focuses on schema creation; testing infrastructure upgrade should be separate story
- **Workaround**: Manual verification of schema if Jest tests fail

**Coverage Target** [Source: docs/architecture/testing-reality.md]:
- Target: 80% code coverage for service layer (applies to future stories)
- For this story: Focus on schema validation tests

### Manual Verification

If unit tests cannot run due to Jest issue:
1. Create schema file
2. Import schema in a test script
3. Log the schema object to verify structure
4. Use MongoDB Compass or CLI to verify indexes after schema is registered

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Story created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

**Created Files:**
- _To be populated by Dev Agent_

**Modified Files:**
- _To be populated by Dev Agent_

**No Files Deleted**

---

## QA Results

_To be populated by QA Agent_
