# Story 1.4: Data Migration Script

**Epic**: 1 - Database Migration Foundation
**Story**: 1.4

---

## Status

**Draft**

---

## Story

**As a** developer
**I want to** create a migration script to transfer existing contacts from MySQL to MongoDB
**So that** no contact data is lost during the database transition

---

## Acceptance Criteria

1. Migration script successfully connects to both MySQL and MongoDB
2. All contact records are transferred from MySQL to MongoDB
3. Data integrity validated (record counts match, all fields populated)
4. Migration is idempotent (can be run multiple times safely)
5. Migration logs progress and any errors
6. Rollback capability documented

---

## Tasks / Subtasks

- [ ] **Task 1: Create scripts directory and migration script file** (AC: 1)
  - [ ] Create `src/scripts/` directory
  - [ ] Create `src/scripts/migrate-contacts.ts` file
  - [ ] Add TypeScript configuration for scripts execution

- [ ] **Task 2: Set up dual database connections** (AC: 1)
  - [ ] Import TypeORM and Mongoose dependencies
  - [ ] Create MySQL connection using TypeORM with existing Contact entity
  - [ ] Create MongoDB connection using Mongoose with Contact schema
  - [ ] Implement connection error handling for both databases
  - [ ] Add environment variable validation (MONGODB_URI and MySQL credentials)

- [ ] **Task 3: Implement data extraction from MySQL** (AC: 2)
  - [ ] Query all contacts from MySQL using TypeORM repository
  - [ ] Log total number of contacts found in MySQL
  - [ ] Handle empty database scenario gracefully
  - [ ] Extract contact fields: id, name, title, email, phone, address, city

- [ ] **Task 4: Implement data transformation** (AC: 2, 3)
  - [ ] Map MySQL integer `id` field (will become MongoDB `_id` ObjectId)
  - [ ] Transform email to lowercase (Mongoose schema requirement)
  - [ ] Trim whitespace from all string fields
  - [ ] Validate required fields exist (name, email)
  - [ ] Set categoryId and tagIds to null/undefined (new fields in Mongoose schema)

- [ ] **Task 5: Implement data insertion to MongoDB** (AC: 2, 3, 4)
  - [ ] Check if contact with same email already exists in MongoDB
  - [ ] Skip duplicate contacts (idempotent behavior)
  - [ ] Insert new contacts using Mongoose model.create()
  - [ ] Handle email uniqueness constraint violations gracefully
  - [ ] Log each successful insertion
  - [ ] Track skipped duplicates count

- [ ] **Task 6: Implement data validation** (AC: 3)
  - [ ] Compare record counts (MySQL source vs MongoDB destination)
  - [ ] Verify all required fields populated in MongoDB
  - [ ] Validate email uniqueness in MongoDB collection
  - [ ] Report any data inconsistencies or missing fields
  - [ ] Generate validation report at end of migration

- [ ] **Task 7: Implement comprehensive logging** (AC: 5)
  - [ ] Log migration start timestamp
  - [ ] Log database connection statuses
  - [ ] Log progress (e.g., "Migrated 50/150 contacts")
  - [ ] Log any errors with contact details
  - [ ] Log migration completion timestamp
  - [ ] Log summary statistics (total, migrated, skipped, errors)

- [ ] **Task 8: Document rollback procedure** (AC: 6)
  - [ ] Document MongoDB collection drop command
  - [ ] Document how to verify MySQL data is intact
  - [ ] Add rollback notes to script comments
  - [ ] Create example rollback commands in script header

- [ ] **Task 9: Create script execution instructions** (AC: 1, 5)
  - [ ] Add script execution command to package.json (`npm run migrate:contacts`)
  - [ ] Document prerequisites (MongoDB and MySQL must be running)
  - [ ] Document environment variables needed
  - [ ] Add usage instructions to script file header

- [ ] **Task 10: Test migration script** (AC: 2, 3, 4)
  - [ ] Test with sample MySQL data
  - [ ] Verify idempotent behavior (run script twice)
  - [ ] Test error handling (database connection failures)
  - [ ] Verify data integrity after migration
  - [ ] Test with empty MySQL database
  - [ ] Test with existing MongoDB data

---

## Dev Notes

### Previous Story Context

**From Story 1.1** [Source: docs/stories/1.1.story.md#dev-agent-record]:
- ✅ NestJS upgraded to **v11.1.8**
- ✅ Mongoose **v8.19.3** installed and configured
- ✅ MongoDB **v8.2.1** running on localhost:27017
- ✅ Database name: `contact-management`
- ✅ ConfigModule configured for environment variables
- ⚠️ TypeORM and MySQL packages still installed (needed for migration)

**From Story 1.2** [Source: docs/prd/epic-1-database-migration.md#story-1.2]:
- Story 1.2 creates the Mongoose Contact schema at `src/contacts/schemas/contact.schema.ts`
- Schema includes all fields: name, title, email, phone, address, city
- Schema includes new fields: categoryId, tagIds (optional)
- Schema has automatic timestamps: createdAt, updatedAt
- Email field must be unique and lowercase

**From Story 1.3** [Source: docs/prd/epic-1-database-migration.md#story-1.3]:
- Story 1.3 migrates the ContactService to use Mongoose
- Story 1.4 DEPENDS on Story 1.2 and 1.3 being completed first
- The Mongoose schema and service must exist before migration can run

### Current Database Configuration

**MySQL (Source Database)** [Source: docs/architecture/source-tree-and-module-organization.md#app-module]:
- Database name: `nestng`
- Connection: localhost (default port 3306)
- Username: `root`
- Password: empty string (development setup)
- Entity: `Contact` from `src/entities/contact.entity.ts`

**MongoDB (Target Database)** [Source: src/app.module.ts:19-25]:
```typescript
MongooseModule.forRootAsync({
  useFactory: () => ({
    uri: process.env.MONGODB_URI || 'mongodb://localhost:27017/contact-management',
  }),
})
```
- Default URI: `mongodb://localhost:27017/contact-management`
- Database name: `contact-management`
- Collection name: `contacts` (auto-created from schema)

### Data Model Mapping

**TypeORM Contact Entity → Mongoose Contact Schema** [Source: docs/architecture/data-models-and-apis.md]:

| MySQL Field | Type | Mongoose Field | Type | Transformation |
|------------|------|----------------|------|----------------|
| `id` | INT AUTO_INCREMENT | `_id` | ObjectId | MongoDB auto-generates, ignore MySQL id |
| `name` | VARCHAR | `name` | String | Direct copy |
| `title` | VARCHAR | `title` | String | Direct copy |
| `email` | VARCHAR | `email` | String | Convert to lowercase |
| `phone` | VARCHAR | `phone` | String | Direct copy |
| `address` | VARCHAR | `address` | String | Direct copy |
| `city` | VARCHAR | `city` | String | Direct copy |
| N/A | - | `categoryId` | ObjectId | Set to null/undefined |
| N/A | - | `tagIds` | ObjectId[] | Set to [] or undefined |
| N/A | - | `createdAt` | Date | Auto-managed by Mongoose |
| N/A | - | `updatedAt` | Date | Auto-managed by Mongoose |

**Important Notes**:
- MySQL `id` field is NOT migrated - MongoDB creates new `_id` ObjectIds
- Email must be converted to lowercase (Mongoose schema constraint)
- categoryId and tagIds are new fields in Mongoose schema (set to null/undefined during migration)
- Timestamps are automatically added by Mongoose when documents are created

### Script Location and Structure

**File Location**: `src/scripts/migrate-contacts.ts` [Source: docs/prd/epic-1-database-migration.md#story-1.4]

**Script Structure**:
```typescript
// Script header with usage instructions and rollback commands

// Import statements
import { NestFactory } from '@nestjs/core';
import { AppModule } from '../app.module';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Contact as TypeORMContact } from '../entities/contact.entity';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { Contact, ContactDocument } from '../contacts/schemas/contact.schema';

// Main migration function
async function migrate() {
  // 1. Initialize NestJS application context
  // 2. Get TypeORM repository for MySQL
  // 3. Get Mongoose model for MongoDB
  // 4. Extract contacts from MySQL
  // 5. Transform and insert into MongoDB
  // 6. Validate data integrity
  // 7. Log summary and close connections
}

// Error handling and script execution
migrate().catch(error => {
  console.error('Migration failed:', error);
  process.exit(1);
});
```

### TypeORM Query Methods (MySQL)

**Reading Contacts from MySQL** [Source: docs/architecture/source-tree-and-module-organization.md#current-contact-service]:
```typescript
// Get TypeORM repository
const typeormContact = app.get(Repository<Contact>);

// Read all contacts
const mysqlContacts = await typeormContact.find();

// Count contacts
const count = await typeormContact.count();
```

### Mongoose Insert Methods (MongoDB)

**Inserting Contacts to MongoDB** [Source: docs/architecture/enhancement-implementation-guide.md#phase-1]:
```typescript
// Get Mongoose model
const mongooseContact = app.get<Model<ContactDocument>>('ContactModel');

// Check if contact exists (by email)
const existing = await mongooseContact.findOne({ email: contact.email.toLowerCase() });

// Insert new contact (Mongoose v8 syntax)
const newContact = await mongooseContact.create({
  name: contact.name,
  title: contact.title,
  email: contact.email.toLowerCase(),
  phone: contact.phone,
  address: contact.address,
  city: contact.city,
  categoryId: null,
  tagIds: [],
});

// Bulk insert option (for performance)
await mongooseContact.insertMany(contacts, { ordered: false });
```

### Idempotency Strategy

**Making Migration Safe to Re-run** [Source: docs/prd/epic-1-database-migration.md#story-1.4]:
- Check if contact with same email exists in MongoDB before inserting
- Skip duplicate contacts (log as "already migrated")
- Use email as unique identifier (Mongoose schema enforces email uniqueness)
- Script should be safe to run multiple times without creating duplicates

**Implementation**:
```typescript
for (const mysqlContact of mysqlContacts) {
  const email = mysqlContact.email.toLowerCase();

  // Check if already migrated
  const existing = await mongooseContact.findOne({ email });

  if (existing) {
    console.log(`Skipping duplicate: ${email}`);
    skippedCount++;
    continue;
  }

  // Insert new contact
  await mongooseContact.create({ ...transformedContact });
  migratedCount++;
}
```

### Error Handling Requirements

**Connection Errors** [Source: docs/prd/epic-1-database-migration.md#story-1.4]:
- Validate MySQL connection is available
- Validate MongoDB connection is available
- Exit gracefully with clear error message if either database is unavailable

**Data Errors**:
- Handle email uniqueness constraint violations
- Handle missing required fields (name, email)
- Log specific contact data that failed to migrate
- Continue migration for other contacts (don't abort entire process)

**Example Error Handling**:
```typescript
try {
  await mongooseContact.create(transformedContact);
  console.log(`✅ Migrated: ${transformedContact.email}`);
  migratedCount++;
} catch (error) {
  console.error(`❌ Failed to migrate ${transformedContact.email}:`, error.message);
  errorCount++;
  errors.push({ email: transformedContact.email, error: error.message });
}
```

### Logging Requirements

**Required Log Output** [Source: docs/prd/epic-1-database-migration.md#story-1.4]:
```
[2025-11-10 10:00:00] Migration started
[2025-11-10 10:00:01] ✅ Connected to MySQL database 'nestng'
[2025-11-10 10:00:02] ✅ Connected to MongoDB database 'contact-management'
[2025-11-10 10:00:03] Found 150 contacts in MySQL
[2025-11-10 10:00:04] ✅ Migrated: john@example.com (1/150)
[2025-11-10 10:00:05] ⏭️  Skipped duplicate: jane@example.com (2/150)
[2025-11-10 10:00:06] ❌ Failed: invalid@example (3/150) - Validation error
...
[2025-11-10 10:01:00] Migration completed
[2025-11-10 10:01:00] Summary:
  - Total MySQL contacts: 150
  - Successfully migrated: 148
  - Skipped (duplicates): 1
  - Failed: 1
  - MongoDB contacts after migration: 149
[2025-11-10 10:01:00] ✅ Data integrity validated: counts match
```

### Validation Strategy

**Post-Migration Validation** [Source: docs/prd/epic-1-database-migration.md#story-1.4]:
1. Compare record counts:
   - MySQL source count
   - MongoDB destination count
   - Should match (accounting for duplicates)
2. Verify required fields populated:
   - All MongoDB contacts have `name` and `email`
3. Verify email uniqueness:
   - No duplicate emails in MongoDB
4. Sample data check:
   - Pick 5 random contacts and compare field values

### Rollback Documentation

**Rollback Procedure** [Source: docs/prd/epic-1-database-migration.md#story-1.4]:

Document these rollback steps in script header comments:

```typescript
/**
 * ROLLBACK PROCEDURE
 *
 * If migration fails or data is incorrect, rollback with these steps:
 *
 * 1. Verify MySQL data is intact:
 *    - Connect to MySQL and verify contacts table exists
 *    - SELECT COUNT(*) FROM contact;
 *
 * 2. Drop MongoDB contacts collection:
 *    - mongosh
 *    - use contact-management
 *    - db.contacts.drop()
 *    - db.contacts.countDocuments() // Should return 0
 *
 * 3. Re-run migration after fixing issues:
 *    - npm run migrate:contacts
 *
 * IMPORTANT: Never drop the MySQL database - it's the source of truth until migration is validated
 */
```

### Script Execution Setup

**NPM Script** [Source: docs/architecture/development-and-deployment.md]:

Add to `package.json`:
```json
{
  "scripts": {
    "migrate:contacts": "ts-node -r tsconfig-paths/register src/scripts/migrate-contacts.ts"
  }
}
```

**Prerequisites Documentation**:
```
Before running migration:
1. Ensure MySQL is running on localhost:3306
2. Ensure MongoDB is running on localhost:27017
3. Ensure Story 1.2 (Contact schema) is completed
4. Ensure Story 1.3 (ContactService migration) is completed
5. Backup MySQL database (optional but recommended)

Run migration:
npm run migrate:contacts
```

### Environment Variables

**Required Variables** [Source: src/app.module.ts]:
- `MONGODB_URI` - MongoDB connection string (default: `mongodb://localhost:27017/contact-management`)
- MySQL connection uses hardcoded values in old TypeORM config (database: 'nestng', username: 'root', password: '')

**Optional Validation**:
The script can validate these environment variables exist before starting migration.

### Dependencies

**Required Packages** [Source: package.json]:
- `typeorm`: ^0.3.27 (for MySQL read) ✅ Already installed
- `mysql` / `mysql2`: ^3.15.3 (MySQL driver) ✅ Already installed
- `@nestjs/typeorm`: ^11.0.0 (NestJS TypeORM integration) ✅ Already installed
- `mongoose`: ^8.19.3 (for MongoDB write) ✅ Already installed
- `@nestjs/mongoose`: ^11.0.3 (NestJS Mongoose integration) ✅ Already installed
- `ts-node`: ^10.9.2 (for running TypeScript scripts) ✅ Already installed

All required packages are already installed - no new dependencies needed.

### NestJS Application Context

**Creating Standalone Application** [Source: NestJS documentation pattern]:
```typescript
import { NestFactory } from '@nestjs/core';
import { AppModule } from '../app.module';

async function migrate() {
  // Create NestJS application context (without HTTP server)
  const app = await NestFactory.createApplicationContext(AppModule);

  // Get repositories/models from DI container
  const typeormRepo = app.get(Repository<Contact>);
  const mongooseModel = app.get<Model<ContactDocument>>('ContactModel');

  // Perform migration...

  // Close application context
  await app.close();
}
```

**Important**: Use `createApplicationContext()` not `create()` - we don't need HTTP server for migration script.

### Project Structure

**Files Involved**:
- `src/scripts/migrate-contacts.ts` - NEW migration script
- `src/entities/contact.entity.ts` - EXISTING TypeORM entity (source)
- `src/contacts/schemas/contact.schema.ts` - DEPENDENCY from Story 1.2 (target)
- `package.json` - ADD migration script command

**No Changes Required**:
- `src/app.module.ts` - Already has both TypeORM and Mongoose configured
- Contact service/controller - Not used by migration script

---

## Testing

### Testing Strategy

**Manual Testing** [Source: docs/architecture/testing-reality.md]:

This is a one-time migration script, so automated unit tests are not required. Instead, focus on manual validation and testing.

**Test Scenarios**:

1. **Happy Path - Full Migration**:
   - Start with MySQL database containing sample contacts
   - Run migration script: `npm run migrate:contacts`
   - Verify all contacts migrated to MongoDB
   - Verify data integrity (counts match, fields populated)

2. **Idempotency Test**:
   - Run migration script first time
   - Run migration script second time
   - Verify no duplicate contacts created
   - Verify "skipped duplicates" logged correctly

3. **Empty Database Test**:
   - Start with empty MySQL database
   - Run migration script
   - Verify script handles empty source gracefully
   - Verify no errors logged

4. **Existing MongoDB Data Test**:
   - Manually insert some contacts into MongoDB
   - Run migration script
   - Verify existing contacts not overwritten
   - Verify only new contacts from MySQL are migrated

5. **Error Handling Test**:
   - Stop MongoDB service
   - Run migration script
   - Verify clear error message about database connection
   - Start MongoDB, stop MySQL
   - Verify clear error message about MySQL connection

6. **Data Validation Test**:
   - After migration, manually verify:
     - Email fields are lowercase
     - Required fields (name, email) populated
     - Timestamps (createdAt, updatedAt) auto-generated
     - categoryId and tagIds are null/undefined

### Test Data Setup

**Sample MySQL Data**:
```sql
-- Insert test contacts into MySQL
USE nestng;
INSERT INTO contact (name, title, email, phone, address, city) VALUES
('John Doe', 'Software Engineer', 'john@example.com', '555-1234', '123 Main St', 'New York'),
('Jane Smith', 'Product Manager', 'jane@example.com', '555-5678', '456 Oak Ave', 'San Francisco'),
('Bob Johnson', 'Designer', 'bob@example.com', '555-9012', '789 Pine Rd', 'Chicago');
```

**Validation Queries**:
```bash
# Check MySQL count
mysql -u root -e "USE nestng; SELECT COUNT(*) FROM contact;"

# Check MongoDB count
mongosh contact-management --eval "db.contacts.countDocuments()"

# Verify MongoDB data
mongosh contact-management --eval "db.contacts.find().limit(5).pretty()"
```

### Success Criteria

**Migration is successful when**:
- ✅ Script runs without crashing
- ✅ All MySQL contacts exist in MongoDB
- ✅ Record counts match (MySQL source = MongoDB destination)
- ✅ All required fields populated in MongoDB
- ✅ Email uniqueness maintained
- ✅ Running script twice doesn't create duplicates
- ✅ Comprehensive logs generated
- ✅ Rollback procedure documented and tested

### Test Commands

```bash
# Run migration
npm run migrate:contacts

# Verify MySQL data (before migration)
mysql -u root nestng -e "SELECT * FROM contact;"

# Verify MongoDB data (after migration)
mongosh contact-management --eval "db.contacts.find().pretty()"

# Check MongoDB collection exists
mongosh contact-management --eval "db.getCollectionNames()"
```

### Known Testing Limitations

[Source: docs/architecture/testing-reality.md]:
- No automated unit tests for migration script (acceptable for one-time migration)
- Manual testing required for validation
- Recommend testing on copy of production MySQL database before running on actual data

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Story created with comprehensive migration details | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

**Created Files:**
- _To be populated by Dev Agent_

**Modified Files:**
- _To be populated by Dev Agent_

**No Files Deleted**

---

## QA Results

_To be populated by QA Agent_
